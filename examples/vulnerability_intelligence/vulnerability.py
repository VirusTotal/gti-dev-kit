# ==========================================================================================================
# This script connects to the Google Threat Intelligence (GTI) API to retrieve the latest vulnerability data.
# It enables security teams to stay informed about critical vulnerabilities by providing detailed summaries
# including risk ratings, CVE identifiers, and executive summaries. The script includes robust error handling
# and retry logic to ensure reliable and consistent data retrieval.
#
# Output Summary:
# The script prints a concise report on recent vulnerabilities, showing CVE IDs, risk ratings,
# and executive summaries to assist in prioritizing security efforts.
#
# Usage:
# - Set your GTI_API_KEY and X_TOOL_HEADER variables with your API key and product name.
# - Run the script to fetch and display the latest vulnerability data.
# - Optionally, modify max_display parameter in print_vulnerability() to show more or fewer vulnerabilities.
# ==========================================================================================================

import requests
from typing import Dict, Any

# API key for Google Threat Intelligence (GTI)
GTI_API_KEY = "YOUR_API_KEY"
# Product name for x-tool header (replace with your actual product name)
X_TOOL_HEADER = "YOUR_PRODUCT_NAME"
# Base URL for Google Threat Intelligence API
BASE_URL = "https://www.virustotal.com/api/v3"

def make_api_request(url: str, params: Dict = None) -> Dict[str, Any]:
    """
    Makes an API request to the GTI endpoint with robust error handling.

    Args:
        url: Full API URL to request.
        params: Optional dictionary of query parameters.

    Returns:
        A dictionary containing:
        - success: Boolean indicating if request was successful.
        - data: JSON data if successful.
        - error: Error message if failed.
        - status_code: HTTP response code.
        - should_retry: Boolean suggesting if retry is appropriate.
    """
    result = {
        'success': False,
        'data': None,
        'error': None,
        'status_code': None,
        'should_retry': False
    }

    headers = {
        "x-apikey": GTI_API_KEY,
        "x-tool": X_TOOL_HEADER
    }

    try:
        response = requests.get(url, headers=headers, params=params, timeout=60)
        result['status_code'] = response.status_code

        if response.status_code == 200:
            try:
                result['data'] = response.json()
                result['success'] = True
            except ValueError as e:
                result['error'] = f"Failed to parse JSON response: {str(e)}"
        elif response.status_code == 400:
            result['error'] = "Bad request - invalid parameters"
        elif response.status_code == 401:
            result['error'] = "Unauthorized - invalid API key"
        elif response.status_code == 403:
            result['error'] = "Forbidden - insufficient permissions"
        elif response.status_code == 404:
            result['error'] = "Endpoint not found"
        elif response.status_code == 429:
            result['error'] = "Rate limit exceeded"
            result['should_retry'] = True
        elif 500 <= response.status_code < 600:
            result['error'] = f"Server error (HTTP {response.status_code})"
            result['should_retry'] = True
        else:
            result['error'] = f"Unexpected HTTP status: {response.status_code}"
    except requests.exceptions.Timeout:
        result['error'] = "Request timed out"
        result['should_retry'] = True
    except requests.exceptions.ConnectionError:
        result['error'] = "Connection error - check your network"
        result['should_retry'] = True
    except requests.exceptions.RequestException as e:
        result['error'] = f"Request failed: {str(e)}"
    except Exception as e:
        result['error'] = f"Unexpected error: {str(e)}"

    return result

def get_vulnerability() -> Dict[str, Any]:
    """
    Fetches the latest vulnerability collections from the GTI API.

    Returns:
        Dictionary with success status, data, or error details.
    """
    url = f"{BASE_URL}/collections"
    params = {'filter': 'collection_type:vulnerability'}
    return make_api_request(url, params=params)

def print_vulnerability(response: Dict, max_display: int = 3) -> None:
    """
    Prints a summary of the vulnerability response.

    Args:
        response: The response dictionary returned by get_vulnerability().
        max_display: Maximum number of vulnerabilities to display from the response.
    """
    try:
        if not response.get('success'):
            print(f"Error fetching vulnerability : {response.get('error', 'Unknown error')}")
            if response.get('should_retry'):
                print("This request might succeed if retried later.")
            return

        data = response.get('data', {}).get('data', [])

        if not data:
            print("No new vulnerabilities received.")
            return

        print(f"\nReceived {len(data)} new vulnerabilities")
        print(f"Displaying top {min(max_display, len(data))} vulnerabilities:")
        
        # Format and print a summary of each vulnerability
        for vuln in data[:max_display]:
            attributes = vuln.get('attributes', {})
            cve_id = attributes.get('cve_id', 'N/A')
            risk_rating = attributes.get('risk_rating', 'N/A')
            executive_summary = attributes.get('executive_summary', 'No summary provided.')

            print(f"\n--- CVE ID: {cve_id} ---")
            print(f"Risk Rating: {risk_rating}")
            print(f"Summary: {executive_summary.replace('*', '').strip()}")
            print("-" * (len(f"CVE ID: {cve_id}") + 6))

    except Exception as e:
        print(f"Error printing vulnerabilities: {str(e)}")

def main():
    """
    Main function to initiate one-time vulnerability fetch.
    Handles retry logic if the first attempt fails and suggests retrying.
    """
    print("Fetching latest vulnerability from Google Threat Intelligence...")
    vulnerability_response = get_vulnerability()

    if not vulnerability_response['success'] and vulnerability_response.get('should_retry'):
        print("\nRetrying failed request...")
        vulnerability_response = get_vulnerability()

    print_vulnerability(vulnerability_response)

if __name__ == "__main__":
    main()